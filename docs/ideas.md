# Gemini Image Downloader - 产品草稿 / Ideas

> 📅 创建时间：2025-12-23  
> 📅 最后更新：2025-12-23  
> 📌 状态：V2.0 需求已确认，准备进入 Plan 阶段

---

## 一、核心需求（V2.0）

**一句话描述**：在 Gemini 网页版中，通过页面内图标和抽屉页，支持单个/批量下载 AI 生成的高清图片，批量下载自动打包成 ZIP 文件。

---

## 二、用户画像与场景

| 项目 | 描述 |
|------|------|
| **目标用户** | Gemini 网页版用户，需要批量保存 AI 生成图片 |
| **使用场景** | 多轮对话生成图片后，想一次性下载全部图片 |
| **当前痛点** | 一张张右键保存太麻烦，效率低下 |
| **下载用途** | 个人存档、素材库、二次编辑 |

---

## 三、V2.0 功能范围

### ✅ 核心功能
1. **页面内图标**：检测到图片时，在 Gemini 页面显示图标（与页面内容同一水平线）
2. **抽屉页**：点击图标打开抽屉，显示图片列表和操作按钮
3. **缩略图展示**：最多显示 10 张图片的缩略图（超过 10 张只显示前 10 张）
4. **单个下载**：每个缩略图右侧有下载按钮，点击直接下载（不打包）
5. **批量下载**：上方"批量下载"按钮，支持全选/批量勾选
6. **ZIP 打包**：选择多张（≥2）时自动打包成 ZIP 下载
7. **实时检测**：使用 MutationObserver 实时监听图片变化
8. **下载状态**：关闭抽屉后，下载任务进行中时显示状态指示器

### 📋 功能细节

#### 3.1 图片展示限制
- **规则**：最多只展示 10 张图片
- **提示**：如果检测到超过 10 张，显示"检测到 X 张，显示前 10 张"

#### 3.2 图片识别逻辑
- **规则**：只要在当前会话中检测到有图片格式存在即可显示图标
- **不要求**：只有图片没有文字（图片和文字可以混合存在）

#### 3.3 图标显示/隐藏
- **显示**：检测到有图片时展示
- **隐藏**：没有图片时消失
- **位置**：与页面内容同一水平线（类似 Poe 或 Im-Writer）
- **下载状态**：关闭抽屉后，任务下载中时显示状态指示器

#### 3.4 任务处理
- **队列管理**：单个任务和批量任务视为不同任务，进入队列
- **优先级**：批量任务先提交时，优先完成批量任务

#### 3.5 文件命名
- **单张**：`Gemini_Image.{ext}`
- **多张（ZIP）**：`Gemini_Image_{数量}.zip`
- **冲突处理**：重名时加数字后缀（`Gemini_Image_5_1.zip`）

#### 3.6 下载方式
- **单张**：直接下载，不打包
- **多张（≥2）**：打包成 ZIP 下载

---

## 四、交互设计

### 4.1 抽屉页设计

#### 位置与尺寸
- **位置**：从右侧滑出
- **宽度**：320px（桌面端）/ 100vw - 40px（移动端）
- **高度**：100vh（全屏高度）
- **层级**：z-index: 999999

#### 动画效果
- **打开/关闭**：0.3 秒平滑过渡
- **缓动函数**：`cubic-bezier(0.4, 0, 0.2, 1)`（Material Design 标准）
- **遮罩层**：半透明黑色背景（rgba(0, 0, 0, 0.3)）

#### 关闭方式
1. 点击外部区域（遮罩层）
2. 点击关闭按钮
3. 按 ESC 键
4. 点击图标（切换）

#### 布局结构
```
┌─────────────────────────────────┐
│ 抽屉头部（固定）                  │
│ - 标题: "Gemini Images"         │
│ - 数量: "5 张图片"               │
│ - [批量下载] 按钮                │
├─────────────────────────────────┤
│ 图片列表（可滚动，最多 10 张）    │
│ - [缩略图1] [下载] [复选框]      │
│ - [缩略图2] [下载] [复选框]      │
│ - ...                           │
├─────────────────────────────────┤
│ 底部状态栏（固定，可选）           │
│ "检测到 15 张，显示前 10 张"     │
└─────────────────────────────────┘
```

### 4.2 图片列表更新

#### 实时更新逻辑
- **新增图片**：自动添加到列表（如果抽屉打开，立即显示）
- **删除图片**：自动从列表移除，如果已选中则自动取消选中
- **页面刷新**：重新检测所有图片，清空选择状态
- **切换对话**：清空当前列表和选择状态，重新检测新对话的图片

#### 检测机制
- **MutationObserver**：监听 DOM 变化（防抖 500ms）
- **定时刷新**：每 5 秒刷新一次（防止遗漏）
- **滚动检测**：滚动时检测（懒加载场景）

---

## 五、图片检测策略增强

### 5.1 双重检测机制

**方法 1：DOM 选择器（优先）**
```javascript
// 参考 GemSaver 的方法
const downloadButtons = document.querySelectorAll(
  'download-generated-image-button button[data-test-id="download-generated-image-button"]'
);
```

**方法 2：URL 模式匹配（回退）**
```javascript
// 当前方法
const isGoogleImage = url.includes('googleusercontent.com');
const isGenerated = url.includes('/gg-dl/') || maxDim >= 200;
```

### 5.2 增强过滤规则
- 更精确的头像识别
- 更精确的图标识别
- 支持新的图片 URL 格式

---

## 六、异常处理

### 6.1 常见异常情况

| 异常类型 | 处理方式 | 用户操作 |
|:---|:---|:---|
| **图片加载失败** | 显示占位图 | 重试 / 直接下载 |
| **下载失败** | 错误提示 | 重试 / 检查权限 |
| **批量部分失败** | 显示成功/失败数量 | 重试失败项 |
| **ZIP 打包失败** | 错误提示 | 降级方案（逐个下载） |
| **检测失败** | 提示信息 | 重新检测 |
| **权限错误** | 错误提示 | 引导到设置 |
| **网络超时** | 超时提示 | 重试 / 检查网络 |

### 6.2 错误提示设计
- **Toast 提示**：短暂显示错误信息（3 秒自动消失）
- **抽屉内状态栏**：显示详细错误信息和操作按钮
- **重试机制**：提供"重试"按钮，支持单次或批量重试

---

## 七、技术调研结论

**已完成调研 ✅**

| 项目 | 结论 |
|------|------|
| **图片 URL 格式** | `https://lh3.googleusercontent.com/...=s1024-rj` |
| **高清版本获取** | 优先使用页面提供的原始图片 URL（部分图片转换 `=s0` 会导致 fetch 失败） |
| **图片选择器** | 结合 DOM 选择器和 URL 模式匹配 |
| **对话标题获取** | `.conversation.selected div` 元素 |

> 📌 技术可行性：**非常高**。参考 GemSaver 项目的实现，结合双重检测机制，提高检测准确性。

---

## 八、参考项目

- **GemSaver**：页面内浮动按钮、DOM 选择器检测、单个下载功能
- **Tab_Right**：任务队列管理、状态管理最佳实践

---

## 九、下一步

1. ✅ **Ideas 阶段完成**：需求已完全澄清
2. ⏳ **进入 Plan 阶段**：制定详细技术方案和开发计划
3. ⏳ **进入开发阶段**：按照 Plan 实施功能开发
