# Gemini Image Downloader - 测试用例

> 📅 版本：v1.1.0.0
> 📅 创建时间：2025-12-27
> 📌 状态：已生成

---

## 🧪 测试用例集 (Test Suite)

### 目录
- [M1: 检测模块 (TP-01)](#m1-检测模块-tp-01)
- [M4: 单个下载 (TP-10)](#m4-单个下载-tp-10)
- [M4: 批量下载 (TP-11)](#m4-批量下载-tp-11)
- [M4: 部分失败处理 (TP-12)](#m4-部分失败处理-tp-12)
- [M5: 队列管理 (TP-13)](#m5-队列管理-tp-13)

---

### M1: 检测模块 (TP-01)

#### TP-01：当 Gemini 页面中存在至少 1 张 AI 生成的图片时，页面内图标必须显示
**风险等级：高风险**

#### TC-001 正常场景 - 单张图片显示图标
*   **标签Tag**：检测模块｜正常流程｜单图检测
*   **Given（给定条件）**：
    *   用户已安装 Gemini Image Downloader 扩展 v1.1.0.0
    *   用户打开 Gemini 页面 gemini.google.com
    *   当前对话中 Gemini 已生成 1 张 AI 图片（完全加载完成）
    *   页面内图标当前为隐藏状态
*   **When（操作步骤）**：
    1.  等待页面加载完成（约 2 秒）
    2.  扩展自动执行图片检测
*   **Then（期望结果）**：
    *   页面右下角出现悬浮图标
    *   图标上的 Badge 显示数字"1"
    *   图标可点击
*   **Checklist（自检勾选项）**：
    *   [ ] 图标在页面右下角可见
    *   [ ] Badge 数字为 1
    *   [ ] 图标悬停时有视觉反馈
    *   [ ] 点击图标可打开抽屉

#### TC-002 正常场景 - 多张图片显示图标
*   **标签Tag**：检测模块｜正常流程｜多图检测
*   **Given（给定条件）**：
    *   用户已安装扩展 v1.1.0.0
    *   当前 Gemini 对话中已生成 5 张 AI 图片（全部加载完成）
    *   页面内图标当前为隐藏状态
*   **When（操作步骤）**：
    1.  等待页面加载完成
    2.  扩展自动执行图片检测
*   **Then（期望结果）**：
    *   页面右下角出现悬浮图标
    *   图标上的 Badge 显示数字"5"
*   **Checklist（自检勾选项）**：
    *   [ ] 图标可见
    *   [ ] Badge 数字为 5
    *   [ ] 打开抽屉后显示 5 张缩略图

#### TC-003 边界场景 - 恰好 10 张图片
*   **标签Tag**：检测模块｜边界条件｜上限检测
*   **Given（给定条件）**：
    *   当前 Gemini 对话中已生成恰好 10 张 AI 图片
    *   所有图片均已加载完成
*   **When（操作步骤）**：
    1.  等待扩展检测完成
    2.  点击悬浮图标打开抽屉
*   **Then（期望结果）**：
    *   图标 Badge 显示"10"
    *   抽屉内显示 10 张缩略图
    *   不显示"检测到更多图片"提示
*   **Checklist（自检勾选项）**：
    *   [ ] Badge 数字为 10
    *   [ ] 抽屉内有 10 张缩略图
    *   [ ] 没有超出提示
    *   [ ] 全选功能选中 10 张

#### TC-004 边界场景 - 超过 10 张图片
*   **标签Tag**：检测模块｜边界条件｜超限检测
*   **Given（给定条件）**：
    *   当前 Gemini 对话中已生成 15 张 AI 图片
    *   所有图片均已加载完成
*   **When（操作步骤）**：
    1.  等待扩展检测完成
    2.  点击悬浮图标打开抽屉
*   **Then（期望结果）**：
    *   图标 Badge 显示"15"
    *   抽屉内只显示前 10 张缩略图
    *   底部显示提示"检测到 15 张，显示前 10 张"
*   **Checklist（自检勾选项）**：
    *   [ ] Badge 数字为 15
    *   [ ] 抽屉内有 10 张缩略图
    *   [ ] 有超出提示文字
    *   [ ] 全选只选中显示的 10 张

#### TC-005 异常场景 - 无图片时图标隐藏
*   **标签Tag**：检测模块｜异常场景｜空状态
*   **Given（给定条件）**：
    *   用户打开 Gemini 页面
    *   当前对话只有纯文字内容，无任何图片
*   **When（操作步骤）**：
    1.  等待页面加载完成（3 秒）
    2.  观察页面右下角区域
*   **Then（期望结果）**：
    *   页面右下角无悬浮图标
    *   无 Badge 显示
*   **Checklist（自检勾选项）**：
    *   [ ] 图标不可见
    *   [ ] 页面布局正常
    *   [ ] 无控制台错误

#### TC-006 异常场景 - 图片加载中
*   **标签Tag**：检测模块｜异常场景｜加载状态
*   **Given（给定条件）**：
    *   用户在 Gemini 中请求生成图片
    *   Gemini 正在生成，显示加载动画
    *   图片尚未完全加载完成
*   **When（操作步骤）**：
    1.  观察扩展检测行为
*   **Then（期望结果）**：
    *   图标暂不显示（或显示但不计入未完成图片）
    *   等图片加载完成后，图标出现/数量更新
*   **Checklist（自检勾选项）**：
    *   [ ] 加载中的图片不计入数量
    *   [ ] 加载完成后数量正确更新
    *   [ ] 无重复检测

#### TC-007 幂等性 - 重复检测不重复计数
*   **标签Tag**：检测模块｜幂等性｜防重复
*   **Given（给定条件）**：
    *   当前对话中有 3 张 AI 图片
    *   扩展已完成首次检测，Badge 显示 3
*   **When（操作步骤）**：
    1.  手动滚动页面触发 MutationObserver
    2.  切换到其他标签页再切回
    3.  打开又关闭抽屉
*   **Then（期望结果）**：
    *   Badge 始终显示"3"
    *   不会出现 6 或 9 等重复计数
*   **Checklist（自检勾选项）**：
    *   [ ] 多次触发后数量不变
    *   [ ] 抽屉内图片不重复
    *   [ ] 无控制台错误

#### TC-008 乱序场景 - 图片生成顺序不影响检测
*   **标签Tag**：检测模块｜乱序｜异步加载
*   **Given（给定条件）**：
    *   用户请求 Gemini 生成 4 张图片
    *   图片 2 和图片 4 先加载完成
    *   图片 1 和图片 3 后加载完成
*   **When（操作步骤）**：
    1.  观察 Badge 数量变化过程
*   **Then（期望结果）**：
    *   Badge 先显示 2，后更新为 4
    *   最终显示正确的总数 4
    *   打开抽屉后顺序为页面中的实际顺序
*   **Checklist（自检勾选项）**：
    *   [ ] 最终数量为 4
    *   [ ] 中间状态合理
    *   [ ] 抽屉内顺序与页面一致

#### TC-009 并发场景 - 快速连续生成图片
*   **标签Tag**：检测模块｜并发｜高频检测
*   **Given（给定条件）**：
    *   当前对话中无图片
    *   用户请求批量生成图片
*   **When（操作步骤）**：
    1.  Gemini 在 1 秒内连续生成 5 张图片
    2.  等待 2 秒让检测稳定
*   **Then（期望结果）**：
    *   Badge 最终显示"5"
    *   抽屉内有 5 张不同的缩略图
*   **Checklist（自检勾选项）**：
    *   [ ] 最终数量准确
    *   [ ] 无遗漏图片
    *   [ ] 无重复图片
    *   [ ] 性能无明显卡顿

#### TC-010 跨状态场景 - 切换对话后重新检测
*   **标签Tag**：检测模块｜跨状态｜对话切换
*   **Given（给定条件）**：
    *   对话 A 中有 3 张图片，Badge 显示 3
    *   对话 B 中有 7 张图片
*   **When（操作步骤）**：
    1.  点击侧边栏切换到对话 B
    2.  等待页面加载和检测完成
*   **Then（期望结果）**：
    *   Badge 更新为"7"
    *   选中状态自动清空
    *   打开抽屉显示对话 B 的 7 张图片
*   **Checklist（自检勾选项）**：
    *   [ ] 数量更新为 7
    *   [ ] 旧选中状态已清空
    *   [ ] 显示的是新对话的图片

#### TC-011 跨状态场景 - 切换到无图片对话
*   **标签Tag**：检测模块｜跨状态｜状态重置
*   **Given（给定条件）**：
    *   当前对话有 5 张图片，图标显示 Badge 5
    *   目标对话只有文字，无图片
*   **When（操作步骤）**：
    1.  切换到无图片的对话
*   **Then（期望结果）**：
    *   图标消失
    *   如果抽屉是打开的，自动关闭
*   **Checklist（自检勾选项）**：
    *   [ ] 图标不可见
    *   [ ] 抽屉自动关闭
    *   [ ] 无残留状态

#### TC-012 跨角色场景 - 非 Gemini 页面不显示
*   **标签Tag**：检测模块｜跨角色｜域名限制
*   **Given（给定条件）**：
    *   用户打开 google.com 或其他非 Gemini 网站
    *   页面中存在图片
*   **When（操作步骤）**：
    1.  观察页面右下角
*   **Then（期望结果）**：
    *   无悬浮图标显示
    *   扩展不执行任何检测逻辑
*   **Checklist（自检勾选项）**：
    *   [ ] 图标不显示
    *   [ ] 无 content script 注入
    *   [ ] 无性能影响

---

### M4: 单个下载 (TP-10)

#### TP-10：点击单个下载按钮时，该图片必须直接下载（不打包），文件名为 `Gemini_Image.{ext}`
**风险等级：高风险**

#### TC-013 正常场景 - 单图下载成功
*   **标签Tag**：下载模块｜正常流程｜单图下载
*   **Given（给定条件）**：
    *   抽屉已打开，显示至少 1 张图片
    *   图片加载正常
*   **When（操作步骤）**：
    1.  点击第 1 张图片右侧的"下载"按钮
*   **Then（期望结果）**：
    *   浏览器触发单个文件下载
    *   文件名为 `Gemini_Image.png` (或 .jpg/.webp)
    *   不生成 ZIP 包
*   **Checklist（自检勾选项）**：
    *   [ ] 触发下载行为
    *   [ ] 文件格式正确（非 ZIP）
    *   [ ] 文件内容可正常打开

#### TC-014 命名冲突 - 单图下载自动重命名
*   **标签Tag**：下载模块｜边界条件｜文件命名
*   **Given（给定条件）**：
    *   下载目录中已存在 `Gemini_Image.png`
*   **When（操作步骤）**：
    1.  点击任意图片的"下载"按钮
*   **Then（期望结果）**：
    *   新下载文件名为 `Gemini_Image (1).png` 或 `Gemini_Image_1.png`（取决于浏览器默认行为或代码逻辑）
    *   不覆盖原有文件
*   **Checklist（自检勾选项）**：
    *   [ ] 下载成功
    *   [ ] 文件名自动添加后缀
    *   [ ] 原文件未被覆盖

#### TC-015 异常场景 - 单图下载网络失败
*   **标签Tag**：下载模块｜异常场景｜网络错误
*   **Given（给定条件）**：
    *   模拟图片资源 URL 失效或网络断开
*   **When（操作步骤）**：
    1.  点击"下载"按钮
*   **Then（期望结果）**：
    *   界面提示"下载失败，请重试"
    *   不生成 0 字节文件
*   **Checklist（自检勾选项）**：
    *   [ ] 出现错误提示
    *   [ ] 无损坏文件残留
    *   [ ] 可再次点击重试

---

### M4: 批量下载 (TP-11)

#### TP-11：选择 ≥2 张图片后点击"批量下载"时，必须打包成 ZIP 文件，文件名为 `Gemini_Image_{数量}.zip`
**风险等级：高风险**

#### TC-016 正常场景 - 批量全选下载
*   **标签Tag**：下载模块｜正常流程｜批量打包
*   **Given（给定条件）**：
    *   抽屉中有 5 张图片
    *   用户点击"全选"（5 张均被选中）
*   **When（操作步骤）**：
    1.  点击顶部"批量下载"按钮
*   **Then（期望结果）**：
    *   浏览器下载一个 ZIP 文件
    *   文件名为 `Gemini_Image_5.zip`
    *   解压后包含 5 张图片
*   **Checklist（自检勾选项）**：
    *   [ ] 触发 ZIP 下载
    *   [ ] 文件名包含数量"5"
    *   [ ] ZIP 内容完整无损坏

#### TC-017 正常场景 - 部分勾选下载
*   **标签Tag**：下载模块｜正常流程｜部分下载
*   **Given（给定条件）**：
    *   抽屉中有 5 张图片
    *   用户只手动勾选了第 1 张和第 3 张（共 2 张）
*   **When（操作步骤）**：
    1.  点击"批量下载"按钮
*   **Then（期望结果）**：
    *   文件名为 `Gemini_Image_2.zip`
    *   解压后只包含勾选的那 2 张图片
*   **Checklist（自检勾选项）**：
    *   [ ] 文件名包含数量"2"
    *   [ ] ZIP 内只有 2 张图片
    *   [ ] 未勾选图片不包含在内

#### TC-018 边界场景 - 只勾选 1 张进行批量下载
*   **标签Tag**：下载模块｜边界条件｜操作逻辑
*   **Given（给定条件）**：
    *   用户只勾选了 1 张图片
*   **When（操作步骤）**：
    1.  尝试点击"批量下载"按钮（或者按钮状态）
*   **Then（期望结果）**：
    *   若按钮可用：下载 ZIP 包（包含 1 张图）或 自动转为单图下载（需确认逻辑，通常 ZIP 统一处理）
    *   若逻辑设定为 ZIP：文件名为 `Gemini_Image_1.zip`
*   **Checklist（自检勾选项）**：
    *   [ ] 行为符合设计预期（建议统一为 ZIP）
    *   [ ] 只有 1 张图片在包内

---

### M4: 部分失败处理 (TP-12)

#### TP-12：批量下载过程中，如果部分图片下载失败，ZIP 文件只包含成功的图片，并显示"已下载 X/Y 张"
**风险等级：高风险**

#### TC-019 异常场景 - 批量下载部分失败
*   **标签Tag**：下载模块｜异常场景｜部分成功
*   **Given（给定条件）**：
    *   用户勾选 5 张图片进行下载
    *   模拟其中 2 张图片 URL 无法访问（404 或超时）
    *   剩余 3 张正常
*   **When（操作步骤）**：
    1.  点击"批量下载"
    2.  等待处理完成
*   **Then（期望结果）**：
    *   下载完成，文件名为 `Gemini_Image_3.zip` (或保持原计划名但内容减少)
    *   界面提示 "下载完成：成功 3 张，失败 2 张"
    *   ZIP 包内只有 3 张图片
*   **Checklist（自检勾选项）**：
    *   [ ] 成功生成 ZIP
    *   [ ] ZIP 能正常解压
    *   [ ] 界面有明确的部分失败提示

#### TC-020 异常场景 - 批量下载全部失败
*   **标签Tag**：下载模块｜异常场景｜全部失败
*   **Given（给定条件）**：
    *   用户勾选 3 张图片
    *   模拟所有图片均无法下载
*   **When（操作步骤）**：
    1.  点击"批量下载"
*   **Then（期望结果）**：
    *   不生成 ZIP 文件
    *   界面提示 "批量下载失败，请重试"
*   **Checklist（自检勾选项）**：
    *   [ ] 未下载 0 字节文件
    *   [ ] 错误提示清晰

---

### M5: 队列管理 (TP-13)

#### TP-13：批量下载任务先提交时，单个下载任务必须等待批量任务完成后再执行
**风险等级：高风险**

#### TC-021 并发场景 - 批量中插入单图下载
*   **标签Tag**：队列模块｜并发场景｜任务排队
*   **Given（给定条件）**：
    *   用户先点击"批量下载"（选中 10 张，模拟耗时 5 秒）
    *   在批量进度条走动时，立即点击某张图的"单个下载"按钮
*   **When（操作步骤）**：
    1.  观察下载行为
*   **Then（期望结果）**：
    *   批量下载继续进行，不受影响
    *   单个下载任务进入队列，等待批量完成后自动开始
    *   或者：两者并行（取决于具体实现，但这里验证是否按 TP-13 描述的串行/阻塞逻辑）
    *   **根据 TP-13 要求**：单图任务应在批量完成后执行
*   **Checklist（自检勾选项）**：
    *   [ ] 批量任务未中断
    *   [ ] 单图任务最终完成
    *   [ ] 浏览器下载栏先后出现两个文件

#### TC-022 并发场景 - 连续点击下载
*   **标签Tag**：队列模块｜并发场景｜防抖动
*   **Given（给定条件）**：
    *   用户在 1 秒内连续快速点击 5 次同一个"单个下载"按钮
*   **When（操作步骤）**：
    1.  观察下载行为
*   **Then（期望结果）**：
    *   应只触发 1 次下载（防抖）
    *   或者：触发 5 次下载但有序进行
    *   建议结果：防抖生效，避免重复下载同一文件
*   **Checklist（自检勾选项）**：
    *   [ ] 没有瞬间弹出 5 个保存框
    *   [ ] 最终文件数量合理
