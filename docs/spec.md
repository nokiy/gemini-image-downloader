# Gemini Image Downloader - SPEC (功能规格说明)

> 📅 版本：v1.0  
> 📅 创建时间：2025-12-23

---

## 一、功能规格

### 1.1 触发方式

| 触发 | 描述 |
|------|------|
| **入口** | 点击 Chrome 工具栏插件图标 |
| **作用域** | 仅在 `gemini.google.com` 域名下激活 |

### 1.2 核心流程

```
用户点击插件图标
    ↓
弹出 Popup 界面
    ↓
点击「下载所有图片」按钮
    ↓
检测当前对话中的所有 AI 生成图片（必要时等待页面加载）
    ↓
打包成 ZIP 文件
    ↓
触发浏览器下载 → 保存到本地
```

---

## 二、图片检测规则

### 2.1 识别条件
- URL 包含 `googleusercontent.com`
- URL 包含 `/gg-dl/`（AI 生成图片标识）

### 2.2 高清获取策略
```
优先使用页面提供的原始图片 URL（通常已是高清）
如需转换，需先验证 =s0 不会导致 fetch 失败
```

### 2.3 排除规则
- 用户上传的图片
- 头像、图标等非内容图片（例如 URL 含 /a/ 或小尺寸图）
- 缩略图

---

## 三、命名规则

### 3.1 ZIP 文件名
```
Gemini_image.zip
```

### 3.2 图片文件名
```
{两位序号}.{ext}
```
ext 根据实际图片类型确定（png/jpg/webp 等）  
示例：`01.png`, `02.jpg`, `03.webp`

---

## 四、边界情况处理

| 场景 | 处理 |
|------|------|
| 当前对话无图片 | 弹出提示「当前对话没有找到图片」 |
| 页面未就绪 | 10 秒内自动检测（每 2 秒重试），并提供「重新检测」按钮 |
| 网络请求失败 | 跳过失败图片，继续下载其他图片 |
| 部分图片下载失败 | 完成后提示「已下载 X/Y 张图片」 |
| 非 Gemini 页面 | 不激活下载按钮，显示提示 |

---

## 五、UI 规格

### 5.1 Popup 界面

```
┌─────────────────────────────┐
│  🖼️ Gemini Image Downloader │
├─────────────────────────────┤
│                             │
│    [ 下载所有图片 ]          │
│                             │
│    [ 重新检测 ]              │
│                             │
│    找到 X 张图片            │
│                             │
└─────────────────────────────┘
```

### 5.2 状态显示

| 状态 | 显示 |
|------|------|
| 加载中 | 「正在检测图片...」 |
| 加载中（等待） | 「页面加载中，自动检测中（已等待 X 秒）」 |
| 就绪 | 「找到 X 张图片」 |
| 下载中 | 「正在下载 X/Y...」|
| 完成 | 「下载完成 ✓」 |
| 无图片 | 「未找到图片」 |

---

## 六、权限要求

| 权限 | 用途 |
|------|------|
| `activeTab` | 访问当前标签页 DOM |
| `downloads` | 触发文件下载 |
| `scripting` | 页面未就绪时注入脚本 |
| `storage` | 持久化下载重命名任务 |
| `host_permissions` | 访问 Gemini 和 Google CDN |
