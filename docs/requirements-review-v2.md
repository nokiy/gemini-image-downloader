# 需求评估报告：V2.0 功能需求 / Requirements Review: V2.0 Features

> 📅 评估日期：2025-12-23  
> 📌 状态：需求评估中（Ideas 阶段）  
> 🎯 目标：识别潜在漏洞和需要澄清的点

---

## 一、需求概述 / Requirements Overview

### 1.1 核心功能点

| 功能点 | 描述 | 优先级 |
|:---|:---|:---|
| **页面内图标** | 检测到 Gemini + 有图片时显示小图标 | P0 |
| **抽屉页** | 点击图标打开抽屉，显示图片列表 | P0 |
| **缩略图展示** | 显示所有检测到的图片缩略图 | P0 |
| **单个下载** | 每个缩略图右侧有下载按钮 | P0 |
| **批量下载** | 上方"批量下载"按钮，支持选择 | P0 |
| **选择功能** | 全选/批量勾选图片 | P0 |
| **ZIP 打包** | 选择多张时自动打包 | P0 |
| **命名规则** | `Gemini Image_{数量}.zip` | P0 |
| **增强检测** | 改进图片检测策略 | P0 |

---

## 二、潜在漏洞分析 / Potential Issues

### 🔴 高优先级问题（必须澄清）

#### 问题 1：触发条件定义不明确
**描述：** "检查到是 Gemini，并且是单纯有图片的形式时"

**潜在漏洞：**
- ❓ **"单纯有图片的形式"** 具体指什么？
  - 是指对话中只有图片，没有文字？
  - 还是指对话中包含图片（无论是否有文字）？
  - 是否需要排除"文字+图片混合"的场景？

**建议澄清：**
```
选项 A：只要检测到至少 1 张 AI 生成的图片就显示图标
选项 B：只有当对话中"只有图片，没有文字消息"时才显示
选项 C：其他定义（请说明）
```

**风险评估：** 🟡 中风险 - 如果定义不清，可能导致功能行为不符合预期

---

#### 问题 2：图标显示/隐藏时机
**描述：** 图标的显示和隐藏逻辑

**潜在漏洞：**
- ❓ 图标何时显示？
  - 页面加载完成后立即检测？
  - 还是等待图片加载完成？
- ❓ 图标何时隐藏？
  - 图片被删除后？
  - 切换到其他对话后？
  - 页面刷新后？
- ❓ 如果图片数量从 0 变为 >0，图标是否自动出现？
- ❓ 如果图片数量从 >0 变为 0，图标是否自动隐藏？

**建议方案：**
```javascript
// 建议：实时监听图片变化
- 初始检测：页面加载后 2 秒检测一次
- 持续监听：MutationObserver 监听 DOM 变化
- 定时刷新：每 5 秒检测一次（防止遗漏）
- 隐藏条件：图片数量为 0 时隐藏图标
```

**风险评估：** 🟡 中风险 - 如果时机不当，用户体验会受影响

---

#### 问题 3：缩略图性能问题
**描述：** 如果检测到大量图片（如 50+ 张），缩略图加载可能影响性能

**潜在漏洞：**
- ⚠️ **内存占用**：同时加载 50+ 张缩略图可能占用大量内存
- ⚠️ **网络请求**：每张缩略图都需要发起网络请求
- ⚠️ **渲染性能**：大量 DOM 元素可能影响页面滚动流畅度
- ⚠️ **加载时间**：用户打开抽屉后需要等待所有缩略图加载

**建议方案：**
```
1. 虚拟滚动（Virtual Scrolling）
   - 只渲染可见区域的缩略图
   - 滚动时动态加载

2. 懒加载（Lazy Loading）
   - 初始只加载前 10 张
   - 滚动到底部时加载更多

3. 缩略图缓存
   - 使用 IndexedDB 缓存已加载的缩略图
   - 避免重复请求

4. 图片尺寸限制
   - 缩略图使用小尺寸版本（如 200x200）
   - 下载时使用原图
```

**风险评估：** 🔴 高风险 - 如果不处理，大量图片场景下会卡顿

---

#### 问题 4：选择状态管理
**描述：** 批量选择的状态如何管理

**潜在漏洞：**
- ❓ 选择状态是否持久化？
  - 关闭抽屉后重新打开，选择状态是否保留？
  - 页面刷新后，选择状态是否保留？
- ❓ 如果图片列表更新（新增/删除），选择状态如何处理？
  - 新增图片：默认未选中？
  - 删除图片：如果已选中，是否自动取消？
- ❓ 全选功能的范围？
  - 全选当前可见的所有图片？
  - 还是全选所有图片（包括未加载的）？

**建议方案：**
```
1. 选择状态存储在内存中（不持久化）
   - 关闭抽屉后清空选择
   - 页面刷新后清空选择

2. 图片列表更新时的处理
   - 使用图片 URL 作为唯一标识
   - 如果 URL 已选中，保持选中状态
   - 如果 URL 不存在，自动取消选中

3. 全选范围
   - 全选当前已加载的所有图片
   - 如果使用虚拟滚动，全选所有图片（包括未加载的）
```

**风险评估：** 🟡 中风险 - 如果处理不当，用户体验会混乱

---

### 🟡 中优先级问题（建议澄清）

#### 问题 5：下载冲突处理
**描述：** 单个下载和批量下载同时进行时的处理

**潜在漏洞：**
- ⚠️ 用户点击"单个下载"后，立即点击"批量下载"会怎样？
- ⚠️ 批量下载进行中，用户点击"单个下载"会怎样？
- ⚠️ 多个"单个下载"同时进行会怎样？

**建议方案：**
```
1. 下载队列管理
   - 单个下载和批量下载共享一个队列
   - 按顺序执行，避免冲突

2. 状态锁定
   - 批量下载进行中，禁用所有单个下载按钮
   - 单个下载进行中，禁用批量下载按钮

3. 进度提示
   - 显示当前下载进度
   - 显示队列中的任务数量
```

**风险评估：** 🟡 中风险 - 如果不处理，可能导致下载失败或重复

---

#### 问题 6：命名冲突
**描述：** ZIP 文件命名规则 `Gemini Image_{数量}.zip`

**潜在漏洞：**
- ⚠️ 如果用户多次下载相同数量的图片，文件名会重复
  - 第一次：`Gemini Image_5.zip`
  - 第二次：`Gemini Image_5.zip`（会覆盖或自动重命名？）
- ⚠️ 如果选择 1 张图片，是否也打包成 ZIP？
  - 需求说"选择超过一张时打包"
  - 但选择 1 张时，是直接下载还是打包？

**建议方案：**
```
1. 命名规则优化
   - 方案 A：`Gemini Image_{数量}_{时间戳}.zip`
     - 例如：`Gemini Image_5_20231223-143022.zip`
   - 方案 B：`Gemini Image_{数量} (1).zip`（Chrome 自动重命名）
     - 例如：`Gemini Image_5.zip`, `Gemini Image_5 (1).zip`

2. 单张图片处理
   - 方案 A：选择 1 张时，直接下载（不打包）
   - 方案 B：选择 1 张时，也打包成 ZIP（保持一致性）
```

**风险评估：** 🟢 低风险 - 但需要明确规则，避免用户困惑

---

#### 问题 7：抽屉页交互细节
**描述：** 抽屉页的具体交互行为

**潜在漏洞：**
- ❓ 抽屉页的打开/关闭动画？
- ❓ 点击抽屉外部区域是否关闭？
- ❓ 抽屉页的尺寸和位置？
  - 从右侧滑出？
  - 从底部滑出？
  - 固定尺寸还是自适应？
- ❓ 抽屉页内的滚动行为？
  - 如果图片很多，是否需要滚动？
  - 滚动时，上方的"批量下载"按钮是否固定？

**建议方案：**
```
1. 抽屉样式（参考 GemSaver）
   - 从右侧滑出
   - 宽度：320px（移动端自适应）
   - 高度：视口高度
   - 背景：白色（支持 Dark Mode）

2. 交互行为
   - 点击外部区域：关闭抽屉
   - ESC 键：关闭抽屉
   - 关闭动画：0.3s 平滑过渡

3. 布局结构
   - 顶部：固定区域（标题 + 批量下载按钮）
   - 中间：可滚动区域（缩略图列表）
   - 底部：固定区域（状态提示，可选）
```

**风险评估：** 🟢 低风险 - 但需要明确，确保用户体验一致

---

### 🟢 低优先级问题（可选优化）

#### 问题 8：图片检测策略增强
**描述：** "还要增加图片检测策略"

**需要澄清：**
- ❓ 具体要增强哪些方面？
  - 提高检测准确性？
  - 支持更多图片格式？
  - 支持更多 Gemini 页面类型？
  - 结合 GemSaver 的 DOM 选择器方法？

**建议方案：**
```
1. 结合 DOM 选择器（参考 GemSaver）
   - 优先使用：`download-generated-image-button` 元素
   - 回退使用：当前的 URL 模式匹配

2. 增强过滤规则
   - 更精确的头像识别
   - 更精确的图标识别
   - 支持新的图片 URL 格式

3. 实时检测优化
   - MutationObserver 监听新图片
   - 定时刷新（每 2 秒）
   - 滚动时检测（懒加载场景）
```

**风险评估：** 🟢 低风险 - 但需要明确具体需求

---

#### 问题 9：错误处理
**描述：** 各种异常情况的处理

**潜在漏洞：**
- ⚠️ 图片加载失败（404、网络错误）
- ⚠️ 缩略图加载失败
- ⚠️ 下载失败（权限、磁盘空间）
- ⚠️ ZIP 打包失败

**建议方案：**
```
1. 缩略图加载失败
   - 显示占位图（placeholder）
   - 显示错误图标
   - 点击时仍可尝试下载

2. 下载失败
   - 显示错误提示
   - 记录失败原因
   - 提供重试按钮

3. 批量下载部分失败
   - 显示成功/失败数量
   - 提供"重试失败项"功能
```

**风险评估：** 🟢 低风险 - 但需要完善，提升用户体验

---

## 三、需要澄清的关键问题 / Key Questions

### 3.1 必须澄清（影响核心功能）

1. **"单纯有图片的形式"的具体定义是什么？**
   - [ ] 选项 A：只要检测到至少 1 张图片就显示
   - [ ] 选项 B：只有图片，没有文字时才显示
   - [ ] 选项 C：其他（请说明）

2. **图标显示/隐藏的时机？**
   - [ ] 何时显示：页面加载后 / 图片加载后 / 其他
   - [ ] 何时隐藏：图片为 0 / 切换对话 / 其他

3. **选择 1 张图片时的行为？**
   - [ ] 直接下载（不打包）
   - [ ] 也打包成 ZIP

4. **ZIP 文件命名冲突如何处理？**
   - [ ] 添加时间戳
   - [ ] 依赖 Chrome 自动重命名
   - [ ] 其他方案

### 3.2 建议澄清（影响用户体验）

5. **缩略图性能优化方案？**
   - [ ] 虚拟滚动
   - [ ] 懒加载
   - [ ] 其他

6. **抽屉页的交互细节？**
   - [ ] 位置：右侧 / 底部 / 其他
   - [ ] 尺寸：固定 / 自适应
   - [ ] 关闭方式：点击外部 / ESC / 其他

7. **图片检测策略的具体增强方向？**
   - [ ] 结合 DOM 选择器
   - [ ] 增强过滤规则
   - [ ] 其他

---

## 四、风险评估总结 / Risk Assessment Summary

| 风险等级 | 问题数量 | 主要问题 |
|:---|:---|:---|
| 🔴 **高风险** | 1 | 缩略图性能问题（大量图片场景） |
| 🟡 **中风险** | 4 | 触发条件、显示时机、选择状态、下载冲突 |
| 🟢 **低风险** | 4 | 命名冲突、交互细节、检测策略、错误处理 |

---

## 五、建议的解决方案 / Recommended Solutions

### 5.1 立即需要澄清的问题

**优先级 P0（阻塞开发）：**
1. ✅ 明确"单纯有图片的形式"的定义
2. ✅ 明确图标显示/隐藏时机
3. ✅ 明确选择 1 张图片时的行为
4. ✅ 确定缩略图性能优化方案（大量图片场景）

**优先级 P1（影响用户体验）：**
5. ✅ 确定抽屉页交互细节
6. ✅ 确定 ZIP 命名规则（冲突处理）
7. ✅ 确定图片检测策略增强方向

### 5.2 建议的技术方案（待确认后实施）

**缩略图性能优化：**
- 推荐：**虚拟滚动 + 懒加载**
- 理由：平衡性能和用户体验

**选择状态管理：**
- 推荐：**内存存储 + URL 唯一标识**
- 理由：简单可靠，符合用户预期

**下载冲突处理：**
- 推荐：**下载队列 + 状态锁定**
- 理由：避免冲突，提升稳定性

---

## 六、下一步行动 / Next Steps

### 6.1 需求确认阶段

1. **与用户确认上述关键问题**
2. **明确技术方案选择**
3. **更新 Ideas 文档**

### 6.2 进入 Plan 阶段（确认后）

1. **创建详细的功能规格文档**
2. **设计技术架构方案**
3. **制定开发计划**

---

> **评估结论**：需求整体清晰，但存在 **9 个需要澄清的关键问题**，其中 **1 个高风险问题**（缩略图性能）和 **4 个中风险问题**（触发条件、显示时机、选择状态、下载冲突）。建议在进入 Plan 阶段前，先澄清这些问题。

